/*!
* Tim
*   github.com/premasagar/tim
*
*//*
    An extensible JavaScript micro-templating library.
*//*

    by Premasagar Rose
        dharmafly.com

    license
        opensource.org/licenses/mit-license.php

    **

    creates global object
        tim

    **

    v0.5.0

*/
(function(a){var b=function(){function b(a){return toString.call(a)==="[object Array]"}function c(b,c,d){return a.slice.call(b,c,d)}function d(a){var b=1,c=arguments.length,e,f;if(c===1)return d(this,a);for(;b<c;b++){e=arguments[b];if(e)for(f in e)e.hasOwnProperty(f)&&(a[f]=e[f])}return a}function e(a){var b,c,d;if(typeof a!="object")this.settings={};else{this.settings=a,a.fn&&(this.fn=a.fn),a.priority&&(this.priority=a.priority),a.context&&(this.context=a.context),b=a.match,c=typeof b;if(c!=="undefined"){this.match=b;if(b.test)d=this._isRegexMatch,c="regexp";else if(c==="function")d=this._isFunctionMatch;else if(c==="string"||c==="number")d=this._isEqualMatch;d&&(this.isMatch=d),this.matchType=c}}}function f(a){a&&this.add.apply(this,arguments)}"use strict";var a=[];return e.prototype={priority:0,match:!0,isMatch:function(){return!!this.match},_isRegexMatch:function(a){return this.match.test(a)},_isFunctionMatch:function(){return this.match.apply(this,arguments)},_isEqualMatch:function(a){return a===this.match},exec:function(){return this.fn.apply(this.context||this,arguments)}},f.prototype=d([],{types:null,autosort:!0,parseRegex:!0,toArray:function(){return c(this)},push:function(){return a.push.apply(this,arguments),this},slice:function(){var b=a.slice.apply(this,arguments);return new f(b)},create:function(a){return typeof a=="function"&&(a={fn:a}),new e(a)},add:function(){var b=a.concat.apply([],arguments),c,d=0,f=b.length;for(;d<f;d++)c=b[d],this.push(c instanceof e?c:this.create(c));return this.autosort?this.sort():this},remove:function(a){var b=typeof a=="number"?a:this.indexOf(a);return b>=0&&this.splice(b,1),this},indexOf:function(a){var b=this.length,c=0;if(a instanceof e){for(;c<b;c++)if(a===this[c])return c}else if(typeof a=="function")for(;c<b;c++)if(a===this[c].fn)return c;return-1},getBy:function(a,b){var c=this.length,d=0,e;for(;d<c;d++){e=this[d];if(typeof e[a]!="undefined")if(typeof b=="undefined"){if(e[a]===b)return e}else if(e[a]===b)return e}return null},filter:function(a,b){var c=this.length,d=new f,e=0;if(b)for(;e<c;e++)this[e].isMatch(a)||d.push(this[e]);else for(;e<c;e++)this[e].isMatch(a)&&d.push(this[e]);return d},sort:function(){function b(a,b){return a.priority-b.priority}return function(c){return a.sort.call(this,c||b),this}}(),exec:function(){var a=0,b=this.length,c;for(;a<b;a++)c=this[a],c.exec.apply(c,arguments);return this},trigger:function(){return this.exec.apply(this,arguments)},transform:function(a){function m(){h=i.fn.apply(i.context||i,d),typeof h!="undefined"&&a!==h&&(a=d[0]=h)}var b={},d=c(arguments).concat(b),e=this.parseRegex,f=0,g=this.length,h,i,j,k,l;for(;f<g;f++){i=this[f];if(i.isMatch.apply(i,d))if(i.matchType==="regexp"&&e){k=i.match,k.lastIndex=0;while(j=k.exec(a))j&&(j.lastIndex=k.lastIndex),d=d.slice(0,-1).concat({matches:j}),m();k.lastIndex=0}else m()}return a},type:function(a,b){var d=this.types,e=d&&d[a];return b?(e||(d||(d=this.types={}),e=d[a]=new f),e.add.apply(e,c(arguments,1)),this):e}}),d(f,{extend:d,isArray:b,toArray:c})}();a.tim=function(a){function b(a){return function(b,c,d){return typeof d=="number"&&(d={priority:d}),this[a].type(b,this.extend({fn:c,context:this},d)),this}}function c(a){return function(b,c){var d=this[a].types;return d&&(c?d[b]&&d[b].remove(c):delete d[b]),this}}function h(a){return this.plugins.getBy(a)}function i(){var a=arguments.length===1?h:f;return a.apply(this,arguments)}function j(a){return this.bind("ready",a)}function k(a,b){var c=this.listeners.types,d=c&&c[a];return d&&d.trigger(b),this}function l(a,b){var c=this.plugins.types,d=c&&c[a],e,f;return d&&(f=this.toArray(arguments,1),b=d.transform.apply(d,f)),b}function m(a,b){var c={template:a,data:b};return this.trigger("parseStart",c),a=c.template=this.parse("template",a,b,c),this.trigger("parseEnd",c),a}function n(a,b){return this.parseTemplate=m,this.initialized=!0,this.trigger("ready").unbind("ready"),typeof a=="undefined"?this:tim.parseTemplate(a,b)}function p(b){function d(a,b){return d.parseTemplate(a,b)}var c={listeners:new a,plugins:new a};return a.extend(d,o,c,b),d}"use strict";var d=b("listeners"),e=c("listeners"),f=b("plugins"),g=c("plugins"),o={startToken:"{{",endToken:"}}",bind:d,plugin:i,ready:j,trigger:k,parse:l,parseTemplate:n,unbind:e,removePlugin:g,create:p,extend:a.extend,isArray:a.isArray,toArray:a.toArray};return p()}(b),tim.regex=function(a){return a||(a={}),new RegExp(this.startToken+(!a.whitespace!=0?"\\s*":"")+(a.closing?"/":"")+(a.prefix||"")+(a.name||"((?:.(?!"+this.endToken+"))*.?)")+(a.suffix||"")+(a.whitespace!==!1?"\\s*":"")+this.endToken,a.flags||"gi")},tim.tagRegex=tim.regex(),tim.cache=function(){var a={};return function(b,c){var d;switch(typeof b){case"undefined":return a;case"string":if(typeof c=="undefined")return a[b];c===!1?delete a[b]:a[b]=c;break;case"object":for(d in b)b.hasOwnProperty(d)&&this.cache(d,b[d]);break;case"boolean":b||(a={})}return this}}(),tim.plugin("template",function(a){return tim.cache(a)},{match:/^[a-z0-9_\-]+$/i}),tim.dom=function(b){b=b||{};var c=b.type||"text/tim",d=b.attr||"class",e=a.document,f=!!e.querySelectorAll,g=f?e.querySelectorAll("script[type='"+c+"']"):e.getElementsByTagName("script"),h=0,i=g.length,j,k,l={};for(;h<i;h++)j=g[h],k=d==="class"?j.className:j.getAttribute(d),k&&(f||j.type===c)&&(l[k]=j.innerHTML);return l},tim.ready(function(){tim.cache&&tim.cache(tim.dom())}),tim.plugin("template",function(a,b,c){var d=this.tagRegex,e,f,g;d.lastIndex=0;while((e=d.exec(a))!==null)f=e[1],g=this.parse("token",f,b,c),g!==f&&(a=a.slice(0,e.index)+g+a.slice(d.lastIndex),d.lastIndex+=g.length-e[0].length);return d.lastIndex=0,a}),tim.plugin("template",function(a,b,c,d){var e=d.matches,f=e[1],g=this.startToken+"/"+f+this.endToken,h=e.index,i=e.lastIndex,j=a.slice(i),k=j.indexOf(g),l,m,n;if(k===-1){tim.trigger("error","Missing closing token in block",this,j,arguments);return}return j=j.slice(0,k),n=tim.extend({},c,{token:f,previousData:b}),j=tim.parse("block",j,b[f],n),l=i+k,m=l+g.length,a.slice(0,h)+j+a.slice(m)},{match:tim.regex({prefix:"#"}),priority:-100}),tim.plugin("token",function(a,b){var c=a.split("."),d=c.length,e=b,f=0;for(;f<d;f++){e=e[c[f]];if(typeof e=="undefined"){this.trigger("error",this,a,arguments);return}if(f===d-1)return this.trigger("success",a,b,e),e}},{match:/^\s*[a-z][a-z0-9_]*\.[a-z][a-z0-9_]*\s*$/}),tim.plugin("token",function(a,b){return b[a]},{match:function(a,b){return typeof b=="object"&&typeof b[a]!="undefined"}}),tim.plugin("block",function(a,b,c){var d=0,e=b.length,f="",g=tim.extend({},c,{array:b,arrayLength:b.length});for(d=0,e=b.length;d<e;d++)g.arrayIndex=d,f+=tim.parse("arrayElement",a,b[d],g);return f},{match:function(a,b){return tim.isArray(b)}}),function(){var a=tim.regex({name:"this",flags:"g"});tim.plugin("arrayElement",function(b,c,d){return b=b.replace(a,c.toString()),tim(b,c)})}(),tim.plugin("block",function(a,b){return tim(a,b)},{match:tim.tagRegex,priority:100}),a.tim=tim})(window)